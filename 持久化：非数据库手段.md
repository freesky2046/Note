### æŒä¹…åŒ–ï¼šéæ•°æ®åº“æ‰‹æ®µ

éæ•°æ®åº“çš„æŒä¹…åŒ–

- UserDefault
- NSKeyedArchiver 
- JSONEncoder
- Dataè¯»å†™

æ•°æ®åº“æŒä¹…åŒ–

- CoreData
- FMDB

- keychain

Demo: [PersistenceDemo](https://github.com/freesky2046/Make/tree/master/PersistenceDemo)

### UserDefault

**ç›®æ ‡**ï¼šè¦æŒä¹…åŒ–çš„å¯¹è±¡åªèƒ½æ˜¯åŸºæœ¬ç±»å‹æˆ–è€…åŸºæœ¬ç±»å‹ä¸ºå…ƒç´ çš„é›†åˆã€‚å¦‚ä¸‹å›¾



![image-20240501203031172](./Image/UserDefault-1.png)





å¦‚æœæ˜¯è‡ªå®šä¹‰ç±»å‹æˆ–è€…è‡ªå®šä¹‰ç±»å‹çš„å…ƒç´ çš„é›†åˆï¼Œæ˜¯ä¸æ”¯æŒçš„ï¼Œä½†<u>å¯ä»¥é€šè¿‡è½¬æ¢ç±»å‹ä¸º `Data` ç±»å‹åï¼Œå†ä¿å­˜</u>ã€‚

**åªé€‚åˆä¿å­˜å°æ•°æ®**:å¯¹äº UserDefault ä¿å­˜çš„å¯¹è±¡ï¼Œå®é™…ä¸Šæ˜¯æ”¾åœ¨æ²™ç›’ç›®å½•**AppData->Library->Preferences**ä¸‹çš„ä¸€ä¸ª plist æ–‡ä»¶ã€‚å…¶ä¸­ key å€¼å°±æ˜¯å£°æ˜çš„ key,value å°±æ˜¯ä¿å­˜çš„æ•°æ®ã€‚ç”±äºæ‰€æœ‰ä½¿ç”¨UserDefaultçš„å†…å®¹éƒ½ä¿å­˜åœ¨é‚£é‡Œï¼Œè€Œä¸”è¯»å–å¯¹è±¡çš„æ—¶å€™éœ€è¦è¯»å–æ•´ä¸ª plist æ–‡ä»¶ï¼Œå› æ­¤åªé€‚åˆä¿å­˜å¾ˆå°çš„æ•°æ®

æŒä¹…åŒ–ä¸€ä¸ªè‡ªå®šä¹‰å¯¹è±¡

```swift
func useJSONEncoder() {
    let user: User = User(name: "john", age: 18)
    let encoder: JSONEncoder = JSONEncoder()
    if let data = try? encoder.encode(user) {
        UserDefaults.standard.setValue(data, forKey: "user")
        let decoder: JSONDecoder = JSONDecoder()
        if let user2 = try? decoder.decode(User.self, from: data) {
            print(user2.name)
            print(user2.age)
        }
    }
}
```



### NSKeyedArchiver 

æœ‰ä¸¤ä¸ªä½œç”¨

- ä¸ä½¿ç”¨data.write(to:options:),ç›´æ¥å°†éµä»NSCodingåè®®çš„è‡ªå®šä¹‰å¯¹è±¡å½’æ¡£åˆ°æ–‡ä»¶ ã€iOS12.0 ä»¥ä¸ŠåºŸå¼ƒã€‘
- åªæ˜¯å°†éµä»NSCodingåè®®è‡ªå®šä¹‰å¯¹è±¡è½¬æ¢ä¸º `Data`ï¼Œä¹‹åçœŸæ­£ç¼“å­˜åˆ°æœ¬åœ°ä½¿ç”¨ Data å¯¹è±¡è‡ªå·±çš„æ–¹æ³•

#### NSCoding åè®®

ä¸ºäº†ä½¿ç”¨NSKeyedArchiveræŒä¹…åŒ–æˆ–ä»…ä»…å°†å¯¹è±¡è½¬ä¸º Data ç±»å‹ï¼Œå¯¹è±¡éœ€è¦éµä» NSCoding åè®®ï¼Œå¹¶ä¸”å®ç°åè®®ä¸­çš„ä¸¤ä¸ªæ–¹æ³•

```swift
func encode(with coder: NSCoder)

required init?(coder: NSCoder)
```

NSCodingåè®®åªèƒ½ç”±Classæ¥éµä»ï¼Œè€Œä¸èƒ½ç”± Struct éµä»ã€‚è¿™é‡Œå®é™…ä½¿ç”¨çš„æ˜¯NSCodingå­ç±»ã€‚å¦åˆ™è°ƒç”¨å½’æ¡£æ–¹æ³•çš„æ—¶å€™ä¼šæŠ¥é”™

```swift
class Dog: NSObject, NSSecureCoding {
    var name: String = ""
    var age: String = ""
    
    func encode(with coder: NSCoder) {
        // å³NSKeyedArchiverç±»å‹
        coder.encode(name, forKey: "name")
        coder.encode(age, forKey: "age")
    }
    
    
    required init?(coder: NSCoder) {
        if let name = coder.decodeObject(forKey: "name") as? String {
            self.name = name
        }else {
            self.name = ""
        }
        if let age = coder.decodeObject(forKey: "age") as? String {
            self.age = age
        }else {
            self.age = "0"
        }
    }
    
    init(name: String, age: String) {
        self.name = name
        self.age = age
    }
    
    static var supportsSecureCoding: Bool { true }
}
```

#### ç›´æ¥å½’æ¡£åˆ°æ–‡ä»¶

```swift
    func useNSKeyedArchiverCache() {
//      archiveRootObject(_:toFile:)' was deprecated in iOS 12.0
//      let dog: Dog = Dog(name: "tom", age: 3)
//      NSKeyedArchiver.archiveRootObject(dog, toFile: ##)
    }
```

è¿™ä¸ª API å·²ç»åœ¨ iOS12 ä¸‹è¢«åºŸå¼ƒï¼Œä½¿ç”¨çš„æ—¶å€™ä¼šæç¤ºè¦åªä½¿ç”¨å®ƒçš„è½¬æ¢ä¸º Data çš„åŠŸèƒ½ï¼Œå†ä½¿ç”¨`data.write(to:options:)`

```swift
'archiveRootObject(_:toFile:)' was deprecated in iOS 12.0: Use +archivedDataWithRootObject:requiringSecureCoding:error: and -writeToURL:options:error: instead
```

#### è½¬æ¢ä¸º Data

```swift
func useNSKeyedArchiverAndDataCache() {
        let dog: Dog = Dog(name: "tom", age: "3")
        if let data = try? NSKeyedArchiver.archivedData(withRootObject: dog, requiringSecureCoding: true) {
            if let dog = try? NSKeyedUnarchiver.unarchivedObject(ofClass: Dog.self, from: data) {
                print("ğŸ˜„" + "\(dog.age)")
                print("ğŸ˜„" + "\(dog.name)")
            }
        }
    }
```

### JSONEncoder

#### **Codable**åè®®

è¦æƒ³å®ç°ç¼–ç å’Œè§£ç ï¼Œåˆ†åˆ«è¦éµä»Encodableå’ŒDecodableä¸¤ä¸ªåè®®ã€‚è€ŒCodableæ˜¯ä¸¤ä¸ªåè®®åŒæ—¶æ»¡è¶³çš„åˆ«å

**è‡ªåŠ¨ç¼–ç å’Œè§£ç **ï¼šå°†Codableæ·»åŠ åˆ°ç±»çš„ç»§æ‰¿åˆ—è¡¨å°±è‡ªåŠ¨å®ç°ç¼–ç æ–¹æ³•å’Œè§£ç æ–¹æ³•ï¼Œä¸éœ€è¦é¢å¤–å®ç°å®ç°ç¼–ç å’Œè§£ç æ–¹æ³•

```swift
struct Product: Codable {
    var name: String
    var price: Double
}
```

#### è½¬æ¢ä¸º Data

```swift
    func useJSONEncoder() {
        // write
        let product: Product = Product(name: "nike", price: 25.3)
        let encoder = JSONEncoder()
        guard let data = try? encoder.encode(product) else { return }
        guard let fileName = fileName() else { return }
        try? data.write(to: URL(fileURLWithPath: fileName))
        

    }

    
    func fileName() -> String? {
        guard let cachePath = NSSearchPathForDirectoriesInDomains(.cachesDirectory, .userDomainMask, true).first else { return nil}
        let  dogPath = (cachePath as NSString).appendingPathComponent("productPath")
        if !FileManager.default.fileExists(atPath: dogPath) {
            try? FileManager.default.createDirectory(at: URL(fileURLWithPath: dogPath), withIntermediateDirectories: true)
        }
        let fileName =  (dogPath as NSString).appendingPathComponent("product")
        return fileName
    }
```

#### è§£ç ä¸ºåŸå§‹å¯¹è±¡

```swift
 // read
guard let data2 = try? Data(contentsOf: URL(fileURLWithPath: fileName)) else { return }
let decoder = JSONDecoder()
guard let product2 = try? decoder.decode(Product.self, from: data2) else { return }

// print
print("ğŸ˜„ \(product2.name)")
print("ğŸ˜„ \(product2.price)")
```



### Data è¯»å†™æ–‡ä»¶

#### **è¯»**

æ ¹æ®æ–‡ä»¶å…¨è·¯å¾„ï¼Œè½¬ä¸º URL åï¼Œä½¿ç”¨ Data çš„ç±»æ–¹æ³•å¯ä»¥è¯»å–

```swift
  guard let data2 = try? Data(contentsOf: URL(fileURLWithPath: fileName)) else { return }
```

#### å†™

```swift
 try? data.write(to: URL(fileURLWithPath: fileName))
```



### é€‰å‹

- å¦‚æœæ˜¯å¾ˆå°çš„æ•°æ®ï¼Œä¼˜é€‰UserDefaultï¼Œæ²¡æœ‰å¿…è¦å°†è¿™éƒ¨åˆ†æ•°æ®ä¿å­˜åœ¨ä¸€ä¸ªç‹¬ç«‹çš„æ–‡ä»¶ã€‚å¦‚æœè¿™ä¸ªå¾ˆå°çš„æ•°æ®ä¸æ˜¯åŸºæœ¬æ•°æ®ç±»å‹æˆ–è€…åŸºæœ¬æ•°æ®ç±»å‹çš„é›†åˆã€‚ä¼˜å…ˆé€‰æ‹©å¯ä»¥é€šè¿‡JSONEncoderè€Œä¸æ˜¯NSKeyedArchiverè½¬æ¢ä¸º Dataç±»å‹,ç„¶åä½¿ç”¨UserDefaultæ¥ä¿å­˜æ•°æ®

- å¦‚æœæ˜¯æ¯”è¾ƒå¤§çš„æ•°æ®ï¼Œå¯ä»¥ä½¿ç”¨JSONEncoderè½¬æ¢ä¸º Dataç±»å‹ï¼Œç„¶åä½¿ç”¨data.write(to:options:) ä¿å­˜åˆ°æŸä¸ªæ–‡ä»¶

- å¦‚æœæ˜¯å¾ˆæ•æ„Ÿçš„æ•°æ®ï¼Œæ¯”å¦‚ç”¨æˆ·è´¦å·ä¸å¯†ç ä¸”ä¸å¸Œæœ›ç”¨æˆ·åˆ æ‰app åä¸¢å¤±ï¼Œå°†æ•°æ®ä¿å­˜åˆ°é’¥åŒ™ä¸²æ˜¯æ¯”è¾ƒå¥½çš„é€‰æ‹©ã€‚

- å¦‚æœæ•°æ®éœ€è¦é¢‘ç¹çš„å¢åˆ æ”¹æŸ¥ï¼Œä½¿ç”¨ sqlite æˆ–è€…è‹¹æœå°è£…çš„ coreData æ˜¯æ¯”è¾ƒå¥½çš„é€‰æ‹©

