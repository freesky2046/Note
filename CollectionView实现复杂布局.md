## CollectionView实现复杂布局

### 零 目录

[TOC]

### 一 流式布局来实现多 section复杂可行吗？

**流式**布局。分为垂直滚动，和水平滚动两种。

- 垂直滚动的时候元素从左往右排列，一行到顶后 换行继续排列
- 水平滚动的时候元素从上往下排列，一列到顶后 换列继续排列

哪怕最简单的复杂布局，也要支持部分 section 水平排列，部分 section 垂直排列，而**流式布局的滚动方式影响的是所有的 section 的排列方式**

结论：可以实现多个 section 但是**只有一个排列方向，意义不大，基本🙈不可以用，哪怕继承 UICollectionViewFlowLayout也不行**。**要继承UICollectionViewLayout**

就如官方所说：您想要的布局看起来一点也不像网格或基于行的断行布局(一种布局，在这种布局中，项目被放置在一行中，直到它被填满，然后继续到下一行，直到所有项目都被放置)，或者需要在多个方向上滚动



### 二 自定义布局原理

在你开始构建自定义布局前，先考虑一下这样做是否真的有必要

- 如果你想要的布局一点也不像网格或是一个行分割的布局(一种布局，其所有数据项都以行的方式放置直到一行填满，然后开始填充下一行直到所有数据项都被放置完成)，或者布局必须在多个方向上滚动
- 如果你想要经常改变所有单元格的位置，修改现有的流动布局比创建一个自定义布局麻烦。

#### 子类化UICollectionViewLayout

只有极少数的提供你的布局对象的核心特性行为(behavior)的方法是需要你自己实现。其它方法则只需要你根据需要重写它们来稍稍调整(tweak)布局行为即可。核心方法处理以下关键任务：

- 指定滚动内容区域的尺寸
- 为组成你的布局的单元格和视图提供属性对象，这样集合视图就可以定位每个单元格和视图。

在布局过程中，集合视图调用布局对象的特定方法。通过这些方法，您可以计算项目的位置，并为集合视图提供所需的主要信息。也可以调用其他方法，但这些方法总是在布局过程中按以下顺序调用:

1. 使用 `prepareLayout` 方法执行提供布局信息所需的前期计算。
2. 使用 `collectionViewContentSize` 方法根据初始计算返回整个内容区域的总体大小。
3. 使用 `layoutAttributesForElementsInRect:` 方法返回**指定矩形**中的单元格和视图的属性。



![流程](https://developer.apple.com/library/archive/documentation/WindowsViews/Conceptual/CollectionViewPGforIOS/Art/cv_layout_process_2x.png)

`prepareLayout` 方法是你执行用来**决定布局中单元格和视图的位置所需要的任何计算的好机会**。 至少，你应该在该方法中计算足够的信息使其能返回内容区的整个尺寸，该尺寸返回到步骤2中的集合视图。布局负责的属性对象都是 `UICollectionViewLayoutAttributes `类的实例。 这些实例可以在应用程序里以一系列不同的方法创建

`layoutAttributesForElementsInRect: `方法在布局对象的`prepareLayout` 方法之后调用，你应该已经有大多数你需要的信息以便返回或创建被请求的各种属性。 layoutAttributesForElementsInRect: 方法的实现遵循以下步骤：

1. Iterate over the data generated by the `prepareLayout` method to either access cached attributes or create new ones.

   迭代由prepareLayout 方法生成的数据，用来访问被缓存属性或创建新属性。

2. Check the frame of each item to see whether it intersects the rectangle passed to the `layoutAttributesForElementsInRect:` method.

   检查每个数据项的框架(frame)，查看它是否跟传递给 layoutAttributesForElementsInRect: 方法的矩形相**交互**。

3. For each intersecting item, add a corresponding `UICollectionViewLayoutAttributes` object to an array.

   **对于每个交互的数据项，添加一个相应的 UICollectionViewLayout 属性对象到一个数组**。

4. Return the array of layout attributes to the collection view.

   把布局属性的数组返回给集合视图。

#### UICollectionViewLayoutAttribute

布局负责的属性对象是`UICollectionViewLayoutAttributes`对象,创建对象有三种方式，正好对应的就是 item 类型的布局,supplementaryview 类型的布局，decoration 类的布局

- ` public convenience init(forCellWith indexPath: IndexPath)`
- `  public convenience init(forSupplementaryViewOfKind elementKind: String, with indexPath: IndexPath)`
- `public convenience init(forDecorationViewOfKind decorationViewKind: String, with indexPath: IndexPath)`

⚠️⚠️ 调用初始化方法的时候可以省去 init。



### 三 实战

自定义layout需要collectionvew和datasource的能力

一 collectionview为layout提供以下能力

1. section个数 【这里的section是**分组数**】    
2. collectionview.contentInset
3. 每一个section的item数

二 datasource为layout提供以下能力

1.每一个section中含有多少列数column

2.返回每一列的高度





### 参考

> [Creating Custom Layouts](https://developer.apple.com/library/archive/documentation/WindowsViews/Conceptual/CollectionViewPGforIOS/CreatingCustomLayouts/CreatingCustomLayouts.html#//apple_ref/doc/uid/TP40012334-CH5-SW3)
>
> [Custom Layouts: A Worked Example](https://developer.apple.com/library/archive/documentation/WindowsViews/Conceptual/CollectionViewPGforIOS/AWorkedExample/AWorkedExample.html)





