## CollectionViewå®žçŽ°å¤æ‚å¸ƒå±€

### é›¶ ç›®å½•

[TOC]

### ä¸€ æµå¼å¸ƒå±€æ¥å®žçŽ°å¤š sectionå¤æ‚å¯è¡Œå—ï¼Ÿ

**æµå¼**å¸ƒå±€ã€‚åˆ†ä¸ºåž‚ç›´æ»šåŠ¨ï¼Œå’Œæ°´å¹³æ»šåŠ¨ä¸¤ç§ã€‚

- åž‚ç›´æ»šåŠ¨çš„æ—¶å€™å…ƒç´ ä»Žå·¦å¾€å³æŽ’åˆ—ï¼Œä¸€è¡Œåˆ°é¡¶åŽ æ¢è¡Œç»§ç»­æŽ’åˆ—
- æ°´å¹³æ»šåŠ¨çš„æ—¶å€™å…ƒç´ ä»Žä¸Šå¾€ä¸‹æŽ’åˆ—ï¼Œä¸€åˆ—åˆ°é¡¶åŽ æ¢åˆ—ç»§ç»­æŽ’åˆ—

å“ªæ€•æœ€ç®€å•çš„å¤æ‚å¸ƒå±€ï¼Œä¹Ÿè¦æ”¯æŒéƒ¨åˆ† section æ°´å¹³æŽ’åˆ—ï¼Œéƒ¨åˆ† section åž‚ç›´æŽ’åˆ—ï¼Œè€Œ**æµå¼å¸ƒå±€çš„æ»šåŠ¨æ–¹å¼å½±å“çš„æ˜¯æ‰€æœ‰çš„ section çš„æŽ’åˆ—æ–¹å¼**

ç»“è®ºï¼šå¯ä»¥å®žçŽ°å¤šä¸ª section ä½†æ˜¯**åªæœ‰ä¸€ä¸ªæŽ’åˆ—æ–¹å‘ï¼Œæ„ä¹‰ä¸å¤§ï¼ŒåŸºæœ¬ðŸ™ˆä¸å¯ä»¥ç”¨ï¼Œå“ªæ€•ç»§æ‰¿ UICollectionViewFlowLayoutä¹Ÿä¸è¡Œ**ã€‚**è¦ç»§æ‰¿UICollectionViewLayout**

å°±å¦‚å®˜æ–¹æ‰€è¯´ï¼šæ‚¨æƒ³è¦çš„å¸ƒå±€çœ‹èµ·æ¥ä¸€ç‚¹ä¹Ÿä¸åƒç½‘æ ¼æˆ–åŸºäºŽè¡Œçš„æ–­è¡Œå¸ƒå±€(ä¸€ç§å¸ƒå±€ï¼Œåœ¨è¿™ç§å¸ƒå±€ä¸­ï¼Œé¡¹ç›®è¢«æ”¾ç½®åœ¨ä¸€è¡Œä¸­ï¼Œç›´åˆ°å®ƒè¢«å¡«æ»¡ï¼Œç„¶åŽç»§ç»­åˆ°ä¸‹ä¸€è¡Œï¼Œç›´åˆ°æ‰€æœ‰é¡¹ç›®éƒ½è¢«æ”¾ç½®)ï¼Œæˆ–è€…éœ€è¦åœ¨å¤šä¸ªæ–¹å‘ä¸Šæ»šåŠ¨



### äºŒ è‡ªå®šä¹‰å¸ƒå±€åŽŸç†

åœ¨ä½ å¼€å§‹æž„å»ºè‡ªå®šä¹‰å¸ƒå±€å‰ï¼Œå…ˆè€ƒè™‘ä¸€ä¸‹è¿™æ ·åšæ˜¯å¦çœŸçš„æœ‰å¿…è¦

- å¦‚æžœä½ æƒ³è¦çš„å¸ƒå±€ä¸€ç‚¹ä¹Ÿä¸åƒç½‘æ ¼æˆ–æ˜¯ä¸€ä¸ªè¡Œåˆ†å‰²çš„å¸ƒå±€(ä¸€ç§å¸ƒå±€ï¼Œå…¶æ‰€æœ‰æ•°æ®é¡¹éƒ½ä»¥è¡Œçš„æ–¹å¼æ”¾ç½®ç›´åˆ°ä¸€è¡Œå¡«æ»¡ï¼Œç„¶åŽå¼€å§‹å¡«å……ä¸‹ä¸€è¡Œç›´åˆ°æ‰€æœ‰æ•°æ®é¡¹éƒ½è¢«æ”¾ç½®å®Œæˆ)ï¼Œæˆ–è€…å¸ƒå±€å¿…é¡»åœ¨å¤šä¸ªæ–¹å‘ä¸Šæ»šåŠ¨
- å¦‚æžœä½ æƒ³è¦ç»å¸¸æ”¹å˜æ‰€æœ‰å•å…ƒæ ¼çš„ä½ç½®ï¼Œä¿®æ”¹çŽ°æœ‰çš„æµåŠ¨å¸ƒå±€æ¯”åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰å¸ƒå±€éº»çƒ¦ã€‚

#### å­ç±»åŒ–UICollectionViewLayout

åªæœ‰æžå°‘æ•°çš„æä¾›ä½ çš„å¸ƒå±€å¯¹è±¡çš„æ ¸å¿ƒç‰¹æ€§è¡Œä¸º(behavior)çš„æ–¹æ³•æ˜¯éœ€è¦ä½ è‡ªå·±å®žçŽ°ã€‚å…¶å®ƒæ–¹æ³•åˆ™åªéœ€è¦ä½ æ ¹æ®éœ€è¦é‡å†™å®ƒä»¬æ¥ç¨ç¨è°ƒæ•´(tweak)å¸ƒå±€è¡Œä¸ºå³å¯ã€‚æ ¸å¿ƒæ–¹æ³•å¤„ç†ä»¥ä¸‹å…³é”®ä»»åŠ¡ï¼š

- æŒ‡å®šæ»šåŠ¨å†…å®¹åŒºåŸŸçš„å°ºå¯¸
- ä¸ºç»„æˆä½ çš„å¸ƒå±€çš„å•å…ƒæ ¼å’Œè§†å›¾æä¾›å±žæ€§å¯¹è±¡ï¼Œè¿™æ ·é›†åˆè§†å›¾å°±å¯ä»¥å®šä½æ¯ä¸ªå•å…ƒæ ¼å’Œè§†å›¾ã€‚

åœ¨å¸ƒå±€è¿‡ç¨‹ä¸­ï¼Œé›†åˆè§†å›¾è°ƒç”¨å¸ƒå±€å¯¹è±¡çš„ç‰¹å®šæ–¹æ³•ã€‚é€šè¿‡è¿™äº›æ–¹æ³•ï¼Œæ‚¨å¯ä»¥è®¡ç®—é¡¹ç›®çš„ä½ç½®ï¼Œå¹¶ä¸ºé›†åˆè§†å›¾æä¾›æ‰€éœ€çš„ä¸»è¦ä¿¡æ¯ã€‚ä¹Ÿå¯ä»¥è°ƒç”¨å…¶ä»–æ–¹æ³•ï¼Œä½†è¿™äº›æ–¹æ³•æ€»æ˜¯åœ¨å¸ƒå±€è¿‡ç¨‹ä¸­æŒ‰ä»¥ä¸‹é¡ºåºè°ƒç”¨:

1. ä½¿ç”¨ `prepareLayout` æ–¹æ³•æ‰§è¡Œæä¾›å¸ƒå±€ä¿¡æ¯æ‰€éœ€çš„å‰æœŸè®¡ç®—ã€‚
2. ä½¿ç”¨ `collectionViewContentSize` æ–¹æ³•æ ¹æ®åˆå§‹è®¡ç®—è¿”å›žæ•´ä¸ªå†…å®¹åŒºåŸŸçš„æ€»ä½“å¤§å°ã€‚
3. ä½¿ç”¨ `layoutAttributesForElementsInRect:` æ–¹æ³•è¿”å›ž**æŒ‡å®šçŸ©å½¢**ä¸­çš„å•å…ƒæ ¼å’Œè§†å›¾çš„å±žæ€§ã€‚



![æµç¨‹](https://developer.apple.com/library/archive/documentation/WindowsViews/Conceptual/CollectionViewPGforIOS/Art/cv_layout_process_2x.png)

`prepareLayout` æ–¹æ³•æ˜¯ä½ æ‰§è¡Œç”¨æ¥**å†³å®šå¸ƒå±€ä¸­å•å…ƒæ ¼å’Œè§†å›¾çš„ä½ç½®æ‰€éœ€è¦çš„ä»»ä½•è®¡ç®—çš„å¥½æœºä¼š**ã€‚ è‡³å°‘ï¼Œä½ åº”è¯¥åœ¨è¯¥æ–¹æ³•ä¸­è®¡ç®—è¶³å¤Ÿçš„ä¿¡æ¯ä½¿å…¶èƒ½è¿”å›žå†…å®¹åŒºçš„æ•´ä¸ªå°ºå¯¸ï¼Œè¯¥å°ºå¯¸è¿”å›žåˆ°æ­¥éª¤2ä¸­çš„é›†åˆè§†å›¾ã€‚å¸ƒå±€è´Ÿè´£çš„å±žæ€§å¯¹è±¡éƒ½æ˜¯ `UICollectionViewLayoutAttributes `ç±»çš„å®žä¾‹ã€‚ è¿™äº›å®žä¾‹å¯ä»¥åœ¨åº”ç”¨ç¨‹åºé‡Œä»¥ä¸€ç³»åˆ—ä¸åŒçš„æ–¹æ³•åˆ›å»º

`layoutAttributesForElementsInRect: `æ–¹æ³•åœ¨å¸ƒå±€å¯¹è±¡çš„`prepareLayout` æ–¹æ³•ä¹‹åŽè°ƒç”¨ï¼Œä½ åº”è¯¥å·²ç»æœ‰å¤§å¤šæ•°ä½ éœ€è¦çš„ä¿¡æ¯ä»¥ä¾¿è¿”å›žæˆ–åˆ›å»ºè¢«è¯·æ±‚çš„å„ç§å±žæ€§ã€‚ layoutAttributesForElementsInRect: æ–¹æ³•çš„å®žçŽ°éµå¾ªä»¥ä¸‹æ­¥éª¤ï¼š

1. Iterate over the data generated by the `prepareLayout` method to either access cached attributes or create new ones.

   è¿­ä»£ç”±prepareLayout æ–¹æ³•ç”Ÿæˆçš„æ•°æ®ï¼Œç”¨æ¥è®¿é—®è¢«ç¼“å­˜å±žæ€§æˆ–åˆ›å»ºæ–°å±žæ€§ã€‚

2. Check the frame of each item to see whether it intersects the rectangle passed to the `layoutAttributesForElementsInRect:` method.

   æ£€æŸ¥æ¯ä¸ªæ•°æ®é¡¹çš„æ¡†æž¶(frame)ï¼ŒæŸ¥çœ‹å®ƒæ˜¯å¦è·Ÿä¼ é€’ç»™ layoutAttributesForElementsInRect: æ–¹æ³•çš„çŸ©å½¢ç›¸**äº¤äº’**ã€‚

3. For each intersecting item, add a corresponding `UICollectionViewLayoutAttributes` object to an array.

   **å¯¹äºŽæ¯ä¸ªäº¤äº’çš„æ•°æ®é¡¹ï¼Œæ·»åŠ ä¸€ä¸ªç›¸åº”çš„ UICollectionViewLayout å±žæ€§å¯¹è±¡åˆ°ä¸€ä¸ªæ•°ç»„**ã€‚

4. Return the array of layout attributes to the collection view.

   æŠŠå¸ƒå±€å±žæ€§çš„æ•°ç»„è¿”å›žç»™é›†åˆè§†å›¾ã€‚

#### UICollectionViewLayoutAttribute

å¸ƒå±€è´Ÿè´£çš„å±žæ€§å¯¹è±¡æ˜¯`UICollectionViewLayoutAttributes`å¯¹è±¡,åˆ›å»ºå¯¹è±¡æœ‰ä¸‰ç§æ–¹å¼ï¼Œæ­£å¥½å¯¹åº”çš„å°±æ˜¯ item ç±»åž‹çš„å¸ƒå±€,supplementaryview ç±»åž‹çš„å¸ƒå±€ï¼Œdecoration ç±»çš„å¸ƒå±€

- ` public convenience init(forCellWith indexPath: IndexPath)`
- `  public convenience init(forSupplementaryViewOfKind elementKind: String, with indexPath: IndexPath)`
- `public convenience init(forDecorationViewOfKind decorationViewKind: String, with indexPath: IndexPath)`

âš ï¸âš ï¸ è°ƒç”¨åˆå§‹åŒ–æ–¹æ³•çš„æ—¶å€™å¯ä»¥çœåŽ» initã€‚



### ä¸‰ å®žæˆ˜

è‡ªå®šä¹‰layoutéœ€è¦collectionvewå’Œdatasourceçš„èƒ½åŠ›

ä¸€ collectionviewä¸ºlayoutæä¾›ä»¥ä¸‹èƒ½åŠ›

1. sectionä¸ªæ•° ã€è¿™é‡Œçš„sectionæ˜¯**åˆ†ç»„æ•°**ã€‘    
2. collectionview.contentInset
3. æ¯ä¸€ä¸ªsectionçš„itemæ•°

äºŒ datasourceä¸ºlayoutæä¾›ä»¥ä¸‹èƒ½åŠ›

1.æ¯ä¸€ä¸ªsectionä¸­å«æœ‰å¤šå°‘åˆ—æ•°column

2.è¿”å›žæ¯ä¸€åˆ—çš„é«˜åº¦





### å‚è€ƒ

> [Creating Custom Layouts](https://developer.apple.com/library/archive/documentation/WindowsViews/Conceptual/CollectionViewPGforIOS/CreatingCustomLayouts/CreatingCustomLayouts.html#//apple_ref/doc/uid/TP40012334-CH5-SW3)
>
> [Custom Layouts: A Worked Example](https://developer.apple.com/library/archive/documentation/WindowsViews/Conceptual/CollectionViewPGforIOS/AWorkedExample/AWorkedExample.html)





